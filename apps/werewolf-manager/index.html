<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/45620091?v=4" type="image/x-icon">
  <title>Quản Trò Ma Sói</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- dom-to-image -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f172a;
      background-image:
        radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
        radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
        radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
      background-attachment: fixed;
    }

    /* Glassmorphism utilities */
    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    .glass-header {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.3);
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(99, 102, 241, 0.6);
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }

    .hidden {
      display: none !important;
    }

    /* Role Colors */
    .role-wolf {
      color: #f87171;
      text-shadow: 0 0 10px rgba(248, 113, 113, 0.3);
    }

    .role-villager {
      color: #60a5fa;
      text-shadow: 0 0 10px rgba(96, 165, 250, 0.3);
    }

    .role-3rd {
      color: #facc15;
      text-shadow: 0 0 10px rgba(250, 204, 21, 0.3);
    }

    @media (max-width: 1023px) {
      .mobile-hidden {
        display: none !important;
      }
    }

    @media print {
      body * {
        visibility: hidden;
      }

      #report-modal,
      #report-modal * {
        visibility: visible;
      }

      #report-modal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: white;
        color: black;
        padding: 0;
        margin: 0;
        overflow: visible;
        display: block !important;
      }

      #report-container {
        border: none;
        box-shadow: none;
        background: white;
        color: black;
      }

      .no-print {
        display: none !important;
      }

      /* Adjust colors for print */
      .text-slate-200,
      .text-slate-300,
      .text-slate-400 {
        color: #000 !important;
      }

      .bg-slate-800,
      .glass-panel {
        background: none !important;
        border: 1px solid #ccc !important;
      }
    }
  </style>
</head>

<body class="text-slate-200 min-h-screen flex flex-col selection:bg-indigo-500 selection:text-white">

  <!-- Report Modal -->
  <div id="report-modal"
    class="hidden fixed inset-0 z-[60] flex justify-center bg-black/90 backdrop-blur-md fade-in p-0 md:p-4 overflow-y-auto">
    <div id="report-container"
      class="bg-slate-900 w-full max-w-4xl min-h-full md:min-h-[80vh] md:rounded-3xl shadow-2xl border border-white/10 relative flex flex-col my-auto">
      <!-- Header with Close & Print -->
      <div
        class="no-print relative z-10 flex justify-between items-center p-4 md:p-6 border-b border-white/10 bg-slate-900/95 backdrop-blur md:rounded-t-3xl">
        <h2 class="text-xl md:text-2xl font-bold text-white flex items-center gap-2"><i data-lucide="scroll-text"
            class="text-indigo-400"></i> Tổng kết ván đấu</h2>
        <div class="flex gap-2">
          <button onclick="exportReportImage()"
            class="p-2 px-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg flex items-center gap-2 transition-colors font-medium shadow-lg shadow-indigo-500/20">
            <i data-lucide="image-down" class="w-4 h-4"></i> <span class="hidden md:inline">Xuất ảnh</span>
          </button>
          <button onclick="closeReportModal()"
            class="p-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <!-- Content -->
      <div id="report-content" class="p-4 md:p-8 space-y-8 text-slate-200 print:text-black">
        <!-- Injected via JS -->
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="glass-header py-4 px-6 sticky top-0 z-40 transition-all duration-300">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div onclick="navigateTo('home')" class="group flex items-center gap-3 cursor-pointer">
        <div class="p-2 bg-indigo-500/20 rounded-lg group-hover:bg-indigo-500/30 transition-colors">
          <i data-lucide="moon" class="text-indigo-400 w-6 h-6"></i>
        </div>
        <div>
          <h1
            class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-200 to-purple-200 tracking-tight">
            Quản Trò Ma Sói</h1>
          <p class="text-[10px] text-slate-400 font-medium tracking-widest uppercase">Mở Rộng 120 Lá</p>
        </div>
      </div>
      <button id="back-btn" onclick="navigateTo('home')"
        class="text-slate-400 hover:text-white flex items-center gap-2 text-sm font-medium px-4 py-2 rounded-lg hover:bg-white/5 transition-all hidden">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        <span>Menu</span>
      </button>
    </div>
  </header>

  <!-- Action Modal -->
  <div id="action-modal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm fade-in p-4">
    <div class="glass-panel w-full max-w-md p-6 rounded-2xl shadow-2xl border border-white/10 relative overflow-hidden">
      <div
        class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none">
      </div>
      <button onclick="closeModal()"
        class="absolute top-4 right-4 p-2 bg-slate-800/50 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors z-10">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
      <div id="modal-content" class="relative z-0"></div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto p-4 md:p-8 flex-1 w-full relative z-0">

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden flex items-center justify-center h-[60vh]">
      <div class="relative">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
        <div class="absolute inset-0 animate-ping rounded-full h-12 w-12 border-2 border-indigo-500 opacity-20"></div>
      </div>
    </div>

    <!-- Home Screen -->
    <div id="home-screen" class="hidden space-y-10 fade-in">
      <div
        class="relative overflow-hidden glass-panel rounded-3xl p-8 md:p-12 text-center md:text-left border-t border-white/10 shadow-2xl">
        <div
          class="absolute top-0 right-0 -mt-20 -mr-20 w-80 h-80 bg-indigo-600/20 rounded-full blur-3xl pointer-events-none">
        </div>
        <div
          class="absolute bottom-0 left-0 -mb-20 -ml-20 w-80 h-80 bg-purple-600/20 rounded-full blur-3xl pointer-events-none">
        </div>

        <div class="relative z-10 flex flex-col md:flex-row gap-8 items-center justify-between">
          <div class="max-w-xl space-y-4">
            <!-- <div
              class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-indigo-300 text-xs font-semibold uppercase tracking-wider mb-2">
              <span class="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-pulse"></span> Offline Mode
            </div> -->
            <h2 class="text-4xl md:text-5xl font-bold text-white tracking-tight">Điều hành ván đấu <br /><span
                class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">chuyên nghiệp
                hơn</span></h2>
            <p class="text-slate-300 text-lg leading-relaxed">
              Hỗ trợ quản trò điều phối và ghi lại lịch sử ván đấu
            </p>
            <div class="pt-4">
              <button onclick="navigateTo('setup')"
                class="group relative px-8 py-4 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/25 transition-all hover:scale-[1.02] active:scale-[0.98]">
                <span class="flex items-center gap-3">
                  <i data-lucide="plus-circle" class="w-5 h-5"></i> Tạo Ván Mới
                </span>
              </button>
            </div>
          </div>
          <div class="hidden md:block opacity-80 mix-blend-lighten">
            <i data-lucide="swords" class="w-64 h-64 text-indigo-500/20" stroke-width="0.5"></i>
          </div>
        </div>
      </div>

      <div class="space-y-6">
        <div class="flex items-center justify-between px-2">
          <h3 class="text-xl font-bold text-slate-200 flex items-center gap-3">
            <div class="p-2 bg-slate-800 rounded-lg"><i data-lucide="history" class="w-5 h-5 text-slate-400"></i></div>
            Lịch sử đấu
          </h3>
        </div>
        <div id="games-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Game items will be injected here -->
        </div>
      </div>
    </div>

    <!-- Setup Screen -->
    <div id="setup-screen" class="hidden fade-in max-w-5xl mx-auto">
      <div class="flex items-center gap-4 mb-8">
        <div class="p-3 bg-indigo-600 rounded-xl shadow-lg shadow-indigo-500/20">
          <i data-lucide="sliders-horizontal" class="text-white w-6 h-6"></i>
        </div>
        <div>
          <h2 class="text-3xl font-bold text-white">Thiết lập ván đấu</h2>
          <p class="text-slate-400 text-sm">Chuẩn bị người chơi và cấu hình vai trò</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
        <!-- Names Input -->
        <div class="lg:col-span-5 flex flex-col gap-4">
          <div class="glass-panel p-6 rounded-2xl flex-1 border-t-4 border-t-indigo-500">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-lg text-white flex items-center gap-2">
                <i data-lucide="users" class="w-5 h-5 text-indigo-400"></i> Danh sách người chơi
              </h3>
              <span class="text-xs bg-slate-800 text-slate-300 px-2 py-1 rounded border border-slate-700">Mỗi tên 1
                dòng</span>
            </div>
            <div class="relative flex-1">
              <textarea id="player-names"
                class="w-full h-[400px] bg-slate-900/50 text-slate-100 p-4 rounded-xl border border-slate-700 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 resize-none transition-all placeholder:text-slate-600 text-sm leading-relaxed custom-scrollbar"
                placeholder="Nguyễn Văn A&#10;Trần Thị B&#10;Lê Văn C..."></textarea>
              <div
                class="absolute bottom-4 right-4 text-xs font-mono bg-slate-800/80 px-2 py-1 rounded text-indigo-300 border border-slate-700 backdrop-blur-sm">
                <span id="total-players-count">0</span> người
              </div>
            </div>
          </div>
        </div>

        <!-- Role Config -->
        <div class="lg:col-span-7 flex flex-col gap-4">
          <div class="glass-panel p-6 rounded-2xl flex-1 border-t-4 border-t-purple-500 flex flex-col h-[500px]">
            <h3 class="font-semibold text-lg text-white mb-4 flex items-center gap-2">
              <i data-lucide="scroll-text" class="w-5 h-5 text-purple-400"></i> Cấu hình vai trò
            </h3>

            <div id="roles-config-list"
              class="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1 bg-slate-900/30 rounded-xl p-2 border border-slate-800/50">
              <!-- Role items injected by JS -->
            </div>

            <div class="mt-6 pt-4 border-t border-white/5 space-y-4">
              <div class="flex justify-between items-center text-sm">
                <div class="flex items-center gap-2">
                  <span class="text-slate-400">Đã chọn:</span>
                  <span id="total-roles-selected" class="font-bold text-white bg-slate-700 px-2 py-0.5 rounded">0</span>
                </div>
                <span id="villager-fill-hint" class="text-indigo-400 font-medium italic"></span>
              </div>

              <div id="setup-error"
                class="hidden p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-200 text-sm flex items-center gap-2">
                <i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>
                <span id="setup-error-msg"></span>
              </div>

              <button onclick="startGame()"
                class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-900/40 transition-all hover:-translate-y-0.5 active:translate-y-0 text-base tracking-wide flex justify-center items-center gap-2 group">
                <i data-lucide="swords" class="w-5 h-5 group-hover:rotate-12 transition-transform"></i>
                BẮT ĐẦU GAME
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Game Screen -->
    <div id="game-screen" class="hidden fade-in h-full max-w-[1400px] mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full items-start">

        <!-- Center: Controls & Players -->
        <div class="lg:col-span-3 space-y-6">
          <!-- Controls Bar -->
          <div
            class="glass-panel p-4 rounded-2xl flex flex-wrap gap-4 justify-between items-center sticky top-24 z-30 shadow-xl border-t border-white/10">
            <div class="flex items-center gap-4">
              <span id="game-phase-badge"
                class="px-4 py-2 rounded-xl font-bold flex items-center gap-2 text-sm shadow-inner transition-colors duration-500">
                <!-- Phase content -->
              </span>
              <div id="game-player-count" class="flex items-center gap-2 text-sm font-medium text-slate-300">
                <!-- Player count injected here -->
              </div>
            </div>
            <div id="game-controls" class="flex gap-3 items-center">
              <!-- Controls injected by JS -->
            </div>
          </div>

          <!-- Players Grid -->
          <div id="players-grid" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4 pb-32 lg:pb-20">
            <!-- Player cards injected here -->
          </div>
        </div>

        <!-- Right: Logs -->
        <div id="log-panel" class="lg:col-span-1 glass-panel rounded-t-2xl lg:rounded-2xl flex flex-col 
                 sticky bottom-0 z-30 lg:relative lg:z-auto lg:inset-auto
                 lg:h-[calc(100vh-140px)] lg:sticky lg:top-24 
                 border-t border-white/10 shadow-[0_-8px_30px_rgba(0,0,0,0.5)] lg:shadow-xl
                 transition-all duration-300 ease-in-out">

          <!-- Header -->
          <div onclick="toggleMobileLogs()"
            class="p-3 lg:p-4 border-b border-white/5 font-bold flex items-center rounded-t-2xl lg:rounded-2xl justify-between bg-slate-900/95 lg:bg-slate-900/40 text-slate-200 cursor-pointer lg:cursor-default backdrop-blur-xl">
            <div class="flex items-center gap-2">
              <i data-lucide="file-text" class="w-4 h-4 text-indigo-400"></i>
              <span>Nhật ký ván đấu</span>
            </div>
            <div class="lg:hidden p-1 rounded-full bg-white/5">
              <i id="log-toggle-icon" data-lucide="chevron-up" class="w-4 h-4 transition-transform duration-300"></i>
            </div>
          </div>

          <!-- Mobile Latest Log Preview -->
          <div id="mobile-latest-log" onclick="toggleMobileLogs()"
            class="lg:hidden p-3 bg-slate-950/95 text-sm text-slate-300 border-b border-white/5 flex items-center gap-3 cursor-pointer">
            <div class="w-2 h-2 rounded-full bg-indigo-500 shrink-0 animate-pulse"></div>
            <span id="mobile-latest-log-text" class="truncate flex-1">Chưa có sự kiện...</span>
          </div>

          <!-- Logs Container -->
          <div id="logs-container"
            class="mobile-hidden lg:block flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-slate-950/90 lg:bg-slate-950/30 max-h-[60vh] lg:max-h-none">
            <div class="text-slate-500 text-center mt-10 text-sm italic">Chưa có sự kiện nào...</div>
          </div>

          <!-- Input Area -->
          <div id="log-input-area"
            class="mobile-hidden lg:block p-3 lg:p-4 border-t border-white/5 bg-slate-900/95 lg:bg-slate-900/60 backdrop-blur-md lg:rounded-b-2xl">
            <div class="flex gap-2 mb-3">
              <input type="text" id="log-input" placeholder="Ghi chú nhanh..."
                class="w-[80%] flex-1 bg-slate-800 text-white px-3 py-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 border border-slate-700 transition-all placeholder:text-slate-600">
              <button onclick="addLogFromInput()"
                class="p-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-colors shadow-lg">
                <i data-lucide="send" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // --- Constants & Config ---
    const ROLES = [
      // --- PHE SÓI ---
      {
        id: 'werewolf', name: 'Ma Sói', icon: 'moon', team: 'Sói', color: 'text-red-400', actions: [
          { id: 'bite', label: 'Cắn', type: 'kill', icon: 'teeth' }
        ]
      },
      {
        id: 'wolf_cub', name: 'Sói Con', icon: 'dog', team: 'Sói', color: 'text-red-300', actions: [
          { id: 'bite', label: 'Cắn (cùng đàn)', type: 'kill', icon: 'teeth' }
        ]
      },
      {
        id: 'white_wolf', name: 'Sói Trắng', icon: 'ghost', team: 'Sói (Độc lập)', color: 'text-slate-300', actions: [
          { id: 'bite', label: 'Cắn (Chung)', type: 'kill', icon: 'teeth' },
          { id: 'white_bite', label: 'Cắn Sói khác', type: 'kill_wolf', icon: 'skull' }
        ]
      },

      // --- PHE DÂN ---
      { id: 'villager', name: 'Dân Làng', icon: 'users', team: 'Dân', color: 'text-blue-300', actions: [] },
      { id: 'two_sisters', name: 'Hai chị em', icon: 'flower', team: 'Dân', color: 'text-pink-200', actions: [] },
      { id: 'three_brothers', name: 'Ba anh em', icon: 'handshake', team: 'Dân', color: 'text-teal-300', actions: [] },
      { id: 'angel', name: 'Thiên Sứ', icon: 'feather', team: 'Thứ 3', color: 'text-yellow-200', actions: [] },
      { id: 'cursed', name: 'Nửa người Nửa sói', icon: 'user-cog', team: 'Dân', color: 'text-stone-400', actions: [] },
      { id: 'elder', name: 'Già Làng', icon: 'user-check', team: 'Dân', color: 'text-blue-400', actions: [] },
      { id: 'idiot', name: 'Thằng Ngốc', icon: 'smile', team: 'Dân', color: 'text-blue-200', actions: [] },
      { id: 'rusty_sword_knight', name: 'Hiệp sĩ kiếm gỉ', icon: 'sword', team: 'Dân', color: 'text-orange-400', actions: [] },
      {
        id: 'fox', name: 'Cáo', icon: 'radar', team: 'Dân', color: 'text-orange-500', actions: [
          { id: 'scan', label: 'Ngửi', type: 'scan_three', icon: 'radar' }
        ]
      },
      {
        id: 'hybrid_wolf', name: 'Sói Lai', icon: 'dog', team: 'Dân', color: 'text-amber-600', actions: [
          { id: 'choose', label: 'Chọn phe', type: 'choose_side', icon: 'shuffle' }
        ]
      },
      {
        id: 'seer', name: 'Tiên Tri', icon: 'eye', team: 'Dân', color: 'text-indigo-300', actions: [
          { id: 'check', label: 'Soi', type: 'info', icon: 'eye' }
        ]
      },
      {
        id: 'bodyguard', name: 'Bảo Vệ', icon: 'shield', team: 'Dân', color: 'text-emerald-300', actions: [
          { id: 'protect', label: 'Bảo vệ', type: 'protect', icon: 'shield' }
        ]
      },
      {
        id: 'hunter', name: 'Thợ Săn', icon: 'crosshair', team: 'Dân', color: 'text-orange-300', actions: [
          { id: 'aim', label: 'Ghim', type: 'hunter_aim', icon: 'crosshair' }
        ]
      },
      {
        id: 'witch', name: 'Phù Thủy', icon: 'flask-conical', team: 'Dân', color: 'text-purple-300', actions: [
          { id: 'save', label: 'Cứu', type: 'revive', icon: 'sparkles' },
          { id: 'poison', label: 'Dùng Độc', type: 'kill', icon: 'skull' }
        ]
      },
      {
        id: 'cupid', name: 'Thần Tình Yêu', icon: 'heart', team: 'Dân', color: 'text-pink-300', actions: [
          { id: 'couple', label: 'Ghép đôi', type: 'couple', icon: 'heart' }
        ]
      },

      // --- PHE THỨ 3 ---
      {
        id: 'pied_piper', name: 'Thổi Sáo', icon: 'music', team: 'Thứ 3', color: 'text-yellow-400', actions: [
          { id: 'charm', label: 'Thôi miên', type: 'charm', icon: 'music' }
        ]
      },
      {
        id: 'thief', name: 'Ăn Trộm', icon: 'drama', team: 'Dân', color: 'text-slate-400', actions: [
          { id: 'steal', label: 'Lấy vai', type: 'steal_role', icon: 'venetian-mask' }
        ]
      },
    ];
    const STORAGE_KEY = 'werewolf_manager_games_v2';
    const SETUP_STORAGE_KEY = 'werewolf_manager_setup_v1';
    const NIGHT_ACTION_ORDER = [
      'thief',
      'cupid',
      'two_sisters',
      'three_brothers',
      'hybrid_wolf',
      'bodyguard',
      'fox',
      'seer',
      'werewolf', // Represents wolf pack
      'wolf_cub', // Represents wolf pack
      'white_wolf',
      'witch',
      'pied_piper',
      'hunter'
    ];


    // --- Global State ---
    let activeGameId = null;
    let currentGameData = null;
    let selectedRoles = {};

    let modalActorId = null;
    let modalActionType = null;
    let cupidSelection = []; // To track selected players for Cupid
    let charmSelection = []; // New: Track selected players for Pied Piper
    let foxSelection = []; // New: Track selected players for Fox

    // --- App Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      renderRoleConfig();
      document.getElementById('player-names').addEventListener('input', (e) => {
        const count = e.target.value.split('\n').filter(n => n.trim()).length;
        document.getElementById('total-players-count').textContent = count;
        updateRoleFillHint(count);
      });
      document.getElementById('log-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addLogFromInput();
      });
      lucide.createIcons();
      navigateTo('home');
    });

    // --- LocalStorage Helpers ---
    function getStoredGames() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch (e) { return []; }
    }
    function saveStoredGames(games) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(games)); } catch (e) { alert("Lỗi lưu trữ!"); }
    }

    // --- Navigation ---
    function navigateTo(screenId) {
      ['home-screen', 'setup-screen', 'game-screen'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('loading-screen').classList.add('hidden');
      if (screenId === 'home') {
        document.getElementById('home-screen').classList.remove('hidden');
        document.getElementById('back-btn').classList.add('hidden');
        loadGamesList();
      } else if (screenId === 'setup') {
        document.getElementById('setup-screen').classList.remove('hidden');
        document.getElementById('back-btn').classList.remove('hidden');
        resetSetupForm();
      } else if (screenId === 'active') {
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('back-btn').classList.remove('hidden');
      }
      lucide.createIcons();
    }

    // --- Setup Logic ---
    function resetSetupForm() {
      // Try loading from storage first
      const savedSetup = localStorage.getItem(SETUP_STORAGE_KEY);
      if (savedSetup) {
        try {
          const data = JSON.parse(savedSetup);
          const names = data.playerNames || '';
          document.getElementById('player-names').value = names;
          const playerCount = names.split('\n').filter(n => n.trim()).length;
          document.getElementById('total-players-count').textContent = playerCount;
          selectedRoles = data.roles || {};
          document.querySelectorAll('[id^="count-"]').forEach(el => el.textContent = '0');
          Object.entries(selectedRoles).forEach(([roleId, count]) => {
            const el = document.getElementById(`count-${roleId}`);
            if (el) el.textContent = count;
          });
          updateTotalRolesUI();
          document.getElementById('setup-error').classList.add('hidden');
          return;
        } catch (e) { console.error("Failed to load setup", e); }
      }
      document.getElementById('player-names').value = '';
      document.getElementById('total-players-count').textContent = '0';
      selectedRoles = {};
      document.querySelectorAll('[id^="count-"]').forEach(el => el.textContent = '0');
      updateTotalRolesUI();
      document.getElementById('setup-error').classList.add('hidden');
    }

    function renderRoleConfig() {
      const container = document.getElementById('roles-config-list');
      container.innerHTML = '';
      ROLES.forEach(role => {
        const el = document.createElement('div');
        el.className = 'flex justify-between items-center bg-slate-800/50 border border-slate-700/50 p-3 rounded-xl hover:bg-slate-800 transition-colors group select-none';
        el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-slate-900 rounded-lg shadow-sm group-hover:scale-110 transition-transform duration-300">
                            <i data-lucide="${role.icon}" class="w-5 h-5 ${role.color}"></i>
                        </div>
                        <div class="flex flex-col">
                             <span class="text-slate-200 font-medium">${role.name}</span>
                             <span class="text-[10px] text-slate-500 uppercase font-bold">${role.team}</span>
                        </div>
                    </div>
                    <div class="flex items-center bg-slate-900 rounded-lg p-1 border border-slate-700/50">
                        <button onclick="changeRoleCount('${role.id}', -1)" class="w-8 h-8 rounded hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white"><i data-lucide="minus" class="w-4 h-4"></i></button>
                        <span id="count-${role.id}" class="w-8 text-center font-mono text-indigo-300 font-bold">0</span>
                        <button onclick="changeRoleCount('${role.id}', 1)" class="w-8 h-8 rounded hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                `;
        container.appendChild(el);
      });
    }

    function changeRoleCount(roleId, delta) {
      const current = selectedRoles[roleId] || 0;
      const next = Math.max(0, current + delta);
      selectedRoles[roleId] = next;
      document.getElementById(`count-${roleId}`).textContent = next;
      updateTotalRolesUI();
    }

    function updateTotalRolesUI() {
      const total = Object.values(selectedRoles).reduce((a, b) => a + b, 0);
      document.getElementById('total-roles-selected').textContent = total;
      const playerNames = document.getElementById('player-names').value;
      const playerCount = playerNames.split('\n').filter(n => n.trim()).length;
      updateRoleFillHint(playerCount, total);
    }

    function updateRoleFillHint(playerCount, roleCount = null) {
      if (roleCount === null) roleCount = Object.values(selectedRoles).reduce((a, b) => a + b, 0);
      const hintEl = document.getElementById('villager-fill-hint');
      hintEl.textContent = roleCount < playerCount ? `(+${playerCount - roleCount} Dân Làng)` : '';
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function startGame() {
      const namesText = document.getElementById('player-names').value;
      const nameList = namesText.split('\n').map(n => n.trim()).filter(n => n);
      if (nameList.length < 4) {
        document.getElementById('setup-error-msg').textContent = 'Cần tối thiểu 4 người chơi!';
        document.getElementById('setup-error').classList.remove('hidden');
        return;
      }

      localStorage.setItem(SETUP_STORAGE_KEY, JSON.stringify({
        playerNames: namesText,
        roles: selectedRoles
      }));

      let deck = [];
      if (!selectedRoles['werewolf'] && !selectedRoles['wolf_cub'] && !selectedRoles['white_wolf']) {
        deck.push(ROLES.find(r => r.id === 'werewolf'));
      }
      Object.entries(selectedRoles).forEach(([roleId, count]) => {
        const roleDef = ROLES.find(r => r.id === roleId);
        for (let i = 0; i < count; i++) deck.push(roleDef);
      });

      const hasThief = selectedRoles['thief'] > 0;
      const minCards = nameList.length + (hasThief ? 2 : 0);

      if (deck.length < minCards) {
        const villager = ROLES.find(r => r.id === 'villager');
        const needed = minCards - deck.length;
        for (let i = 0; i < needed; i++) {
          deck.push(villager);
        }
      } else if (deck.length > minCards) {
        let villagers = deck.filter(r => r.id === 'villager');
        let specials = deck.filter(r => r.id !== 'villager');
        let toRemove = deck.length - minCards;

        if (villagers.length >= toRemove) villagers.splice(0, toRemove);
        else { toRemove -= villagers.length; villagers = []; specials = shuffleArray(specials); specials.splice(0, toRemove); }
        deck = [...specials, ...villagers];
      }

      deck = shuffleArray(deck);
      const assignedCards = deck.slice(0, nameList.length);
      const leftoverRoles = hasThief ? deck.slice(nameList.length, nameList.length + 2) : [];

      const players = nameList.map((name, idx) => ({
        id: crypto.randomUUID(),
        name: name,
        role: { id: assignedCards[idx].id, name: assignedCards[idx].name, team: assignedCards[idx].team },
        isAlive: true,
        isSheriff: false, // New: Sheriff Status
        isCharmed: false,
        isLover: false, // New for Cupid
        loverId: null, // New for Cupid
        elderLives: deck[idx].id === 'elder' ? 2 : 1,
        revealed: false,
        deathPhase: null, // Track when player died
        usedAbilities: [],
        originalRole: null
      }));

      const newGame = {
        id: crypto.randomUUID(),
        createdAt: new Date().toISOString(),
        status: 'active',
        players: players,
        logs: [],
        currentPhase: 'setup',
        dayCount: 1,
        lastProtectedId: null,
        protectedId: null,
        nextNightExtraKills: 0,
        elderPenaltyActive: false,
        hunterTargetId: null,
        wolfKillCount: 0,
        maxWolfKills: 1,
        leftoverRoles: []
      };

      const games = getStoredGames();
      games.push(newGame);
      saveStoredGames(games);
      loadGame(newGame.id);
    }

    // --- Active Game Logic ---
    function loadGame(gameId) {
      const games = getStoredGames();
      const game = games.find(g => g.id === gameId);
      if (!game) { alert("Không tìm thấy!"); navigateTo('home'); return; }
      activeGameId = gameId;
      currentGameData = game;
      renderGameUI();
      navigateTo('active');
    }

    function isRoleActiveThisNight(player, gameData) {
      if (gameData.currentPhase !== 'night' || !player.isAlive) {
        return false;
      }

      const roleId = player.role.id;
      const day = gameData.dayCount;

      // Roles that only act on night 1
      const night1Roles = ['thief', 'cupid', 'two_sisters', 'three_brothers', 'hybrid_wolf'];
      if (night1Roles.includes(roleId) && day > 1) {
        return false;
      }

      // White wolf's special bite is only on even nights, but they can still bite with the pack on any night.
      // So, we don't return false here. The action availability is handled later.

      // Witch check for used abilities
      if (roleId === 'witch') {
        const usedAbilities = player.usedAbilities || [];
        if (usedAbilities.includes('save') && usedAbilities.includes('poison')) {
          return false; // No potions left
        }
      }

      // General check for any actions
      const roleDef = ROLES.find(r => r.id === roleId);
      return roleDef && roleDef.actions && roleDef.actions.length > 0;
    }

    function renderGameUI() {
      if (!currentGameData) return;
      const isNight = currentGameData.currentPhase === 'night';

      // Badge
      const badge = document.getElementById('game-phase-badge');
      const icon = isNight ? 'moon' : 'sun';
      const text = currentGameData.currentPhase === 'setup' ? 'CHUẨN BỊ'
        : isNight ? `ĐÊM ${currentGameData.dayCount}`
          : `NGÀY ${currentGameData.dayCount}`;
      badge.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i> ${text}`;
      badge.className = `px-4 py-2 rounded-xl font-bold flex items-center gap-2 text-sm shadow-inner transition-colors ${isNight ? 'bg-indigo-950 text-indigo-200' : 'bg-amber-500 text-white'}`;

      // Player Count
      const playerCountContainer = document.getElementById('game-player-count');
      const alivePlayers = currentGameData.players.filter(p => p.isAlive).length;
      const totalPlayers = currentGameData.players.length;
      playerCountContainer.innerHTML = `<i data-lucide="users" class="w-4 h-4 text-slate-400"></i>
                <span>${alivePlayers} / ${totalPlayers}</span>`;

      // Controls
      const controls = document.getElementById('game-controls');
      controls.innerHTML = `
                ${currentGameData.currentPhase === 'setup' ? `<button onclick="rerollRoles()" class="px-4 py-2 bg-purple-600 rounded-lg text-sm text-white flex items-center gap-2"><i data-lucide="shuffle" class="w-4 h-4"></i> Đảo vai</button>` : ''}
                <button onclick="showNightOrder()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-200 flex items-center gap-2 border border-slate-600"><i data-lucide="list-ordered" class="w-4 h-4"></i> Thứ tự</button>
                <button onclick="nextPhase()" class="px-4 py-2 bg-indigo-600 rounded-lg text-sm text-white flex items-center gap-2"><i data-lucide="moon-star" class="w-4 h-4"></i> Chuyển pha</button>
                <div class="h-6 w-[1px] bg-white/10 mx-1"></div>
                <button onclick="finishGame()" class="px-3 py-2 bg-red-500/10 text-red-400 rounded-lg text-sm flex items-center gap-2 border border-red-500/20"><i data-lucide="flag" class="w-4 h-4"></i> Kết thúc</button>
            `;

      // Players
      const grid = document.getElementById('players-grid');
      grid.innerHTML = '';

      // Check for Just Died logic: Died in the immediately preceding night
      // The preceding night is "night_" + currentDayCount if currentPhase is day
      const checkDeathPhase = currentGameData.currentPhase === 'day' ? `night_${currentGameData.dayCount}` : null;

      // Sắp xếp người chơi theo thứ tự thực hiện chức năng, không tính sống/chết
      const sortedPlayers = [...currentGameData.players].sort((a, b) => {
        const roleIndexA = NIGHT_ACTION_ORDER.indexOf(a.role.id);
        const roleIndexB = NIGHT_ACTION_ORDER.indexOf(b.role.id);

        // Đưa những vai không có trong thứ tự hành động xuống cuối
        if (roleIndexA === -1 && roleIndexB !== -1) return 1;
        if (roleIndexA !== -1 && roleIndexB === -1) return -1;

        // Sắp xếp theo thứ tự trong NIGHT_ACTION_ORDER
        if (roleIndexA !== -1 && roleIndexB !== -1) return roleIndexA - roleIndexB;

        // Giữ nguyên thứ tự ban đầu nếu cả hai đều không có trong danh sách
        return 0;
      });

      sortedPlayers.forEach(p => {
        const roleDef = ROLES.find(r => r.id === p.role.id) || ROLES[1];
        const originalRoleDef = p.originalRole ? ROLES.find(r => r.id === p.originalRole.id) : null;
        const card = document.createElement('div');
        const isWolfTeam = ['Sói', 'Sói (Độc lập)'].includes(p.role.team);
        const is3rdParty = p.role.team === 'Thứ 3';
        const isJustDied = checkDeathPhase && p.deathPhase === checkDeathPhase;

        let cardClass = `relative p-4 rounded-xl border transition-all duration-300 group select-none cursor-pointer `;
        if (p.isAlive) {
          cardClass += `bg-slate-800/80 hover:bg-slate-700 border-slate-700 hover:border-indigo-500 hover:-translate-y-1 `;
          if (isWolfTeam) cardClass += 'border-b-red-900/50 ';
          else if (is3rdParty) cardClass += 'border-b-yellow-900/50 ';
          else if (p.role.id === 'two_sisters') cardClass += 'border-b-pink-500/50 shadow-[0_0_15px_rgba(236,72,153,0.15)] ';
          else if (p.role.id === 'three_brothers') cardClass += 'border-b-teal-500/50 shadow-[0_0_15px_rgba(45,212,191,0.15)] ';
          else cardClass += 'border-b-blue-900/50 ';
        } else {
          cardClass += `bg-slate-900/50 border-slate-800 opacity-60 grayscale scale-[0.98] `;
          if (isJustDied) {
            cardClass += `ring-2 ring-red-500/50 animate-pulse `; // Highlight recent death
          }
        }

        card.className = cardClass;
        card.onclick = () => handlePlayerClick(p.id);

        // Icons for status
        let statusIcons = '';
        if (p.isSheriff) statusIcons += `<div class="flex items-center gap-1 bg-yellow-500/20 px-1.5 py-0.5 rounded border border-yellow-500/40" title="Cảnh sát trưởng (2 phiếu)"><i data-lucide="star" class="w-3.5 h-3.5 text-yellow-500 fill-yellow-500"></i><span class="text-[10px] text-yellow-200 font-bold">2P</span></div>`;
        if (p.isCharmed) statusIcons += `<i data-lucide="music" class="w-4 h-4 text-yellow-400 animate-pulse"></i>`;
        if (p.isLover) statusIcons += `<i data-lucide="heart" class="w-4 h-4 text-pink-400 animate-pulse"></i>`;
        if (p.role.id === 'elder' && p.isAlive) statusIcons += `<span class="text-[10px] font-bold bg-blue-500/20 text-blue-300 px-1 rounded">${p.elderLives}❤️</span>`;
        if (p.role.id === 'idiot' && p.revealed && p.isAlive) statusIcons += `<span class="text-[10px] font-bold bg-slate-500/20 text-slate-300 px-1 rounded">Đã lật</span>`;

        card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="font-bold text-slate-100 truncate pr-2 text-lg ${!p.isAlive && 'line-through text-slate-500'}">${p.name}</div>
                        ${!currentGameData.currentPhase === 'setup' ? `<button onclick="event.stopPropagation();manualTogglePlayer('${p.id}')" class="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center"><i data-lucide="${p.isAlive ? 'skull' : 'heart'}" class="w-3 h-3"></i></button>` : ''}
                    </div>
                    <div class="flex items-end justify-between mt-auto">
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2 px-2 py-1 rounded-lg ${isWolfTeam ? 'bg-red-500/10 text-red-300' : (is3rdParty ? 'bg-yellow-500/10 text-yellow-300' : 'bg-blue-500/10 text-blue-300')} border border-white/5">
                                <i data-lucide="${roleDef.icon}" class="w-3.5 h-3.5"></i> 
                                <span class="text-xs font-semibold">${p.role.name}</span>
                            </div>
                            ${p.originalRole && originalRoleDef ? `
                            <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-slate-700/50 text-slate-400 border border-white/5 w-fit">
                                <i data-lucide="${originalRoleDef.icon}" class="w-3.5 h-3.5"></i> 
                                <span class="text-xs font-semibold">${p.originalRole.name}</span>
                            </div>
                            ` : ''}
                            ${p.isLover ? `
                            <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-pink-500/10 text-pink-300 border border-pink-500/30 w-fit">
                                <i data-lucide="heart" class="w-3.5 h-3.5"></i> 
                                <span class="text-xs font-semibold">Tình Nhân</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="flex gap-1 items-center self-end">
                            ${statusIcons}
                            ${!p.isAlive ? (isJustDied
            ? '<span class="text-[10px] text-white bg-red-600 font-bold uppercase px-1.5 py-0.5 rounded shadow-lg shadow-red-500/50 animate-bounce">Mới chết</span>'
            : '<span class="text-[10px] text-red-500 font-bold uppercase border border-red-500/30 px-1 rounded">Dead</span>')
            : ''}
                        </div>
                    </div>
                `;
        grid.appendChild(card);
      });

      // Logs
      renderLogs();
      lucide.createIcons();
    }

    // --- Render Logs Function ---
    function renderLogs() {
      const container = document.getElementById('logs-container');
      const mobilePreviewText = document.getElementById('mobile-latest-log-text');

      if (!currentGameData.logs?.length) {
        container.innerHTML = '<div class="text-slate-500 text-center mt-20 text-sm italic">Chưa có sự kiện nào...</div>';
        if (mobilePreviewText) mobilePreviewText.textContent = "Chưa có sự kiện...";
        return;
      }
      container.innerHTML = '';

      // Build current phase string
      const currentPhaseStr = currentGameData.currentPhase === 'night'
        ? `Đêm ${currentGameData.dayCount}`
        : `Ngày ${currentGameData.dayCount}`;

      // Update mobile preview
      const latestLog = currentGameData.logs[currentGameData.logs.length - 1];
      if (mobilePreviewText && latestLog) {
        mobilePreviewText.textContent = latestLog.text;
      }

      [...currentGameData.logs].reverse().forEach(log => {
        const row = document.createElement('div');
        row.className = 'relative pl-4 pb-4 border-l border-slate-700 last:border-0 last:pb-0 group';
        const isNight = log.phase.includes('Đêm');

        // Show 'x' only for current phase
        const canDelete = (log.phase === currentPhaseStr);

        row.innerHTML = `
                    <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full ${isNight ? 'bg-indigo-500' : 'bg-amber-500'} ring-4 ring-slate-900"></div>
                    <div class="flex flex-col gap-1 pr-6">
                         <div class="flex items-center gap-2">
                             <span class="text-[10px] font-bold uppercase ${isNight ? 'text-indigo-400' : 'text-amber-400'}">${log.phase}</span>
                             <span class="text-[10px] text-slate-500 font-mono">${new Date(log.time).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</span>
                         </div>
                         <div class="text-slate-300 text-sm bg-slate-800/40 p-2 rounded-lg border border-white/5">${log.text}</div>
                    </div>
                    ${canDelete ? `<button onclick="confirmDeleteLog('${log.id}')" class="absolute top-2 right-0 p-1 text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100"><i data-lucide="x" class="w-4 h-4"></i></button>` : ''}
                `;
        container.appendChild(row);
      });
      lucide.createIcons();
    }

    // --- Action Logic ---
    function handlePlayerClick(playerId) {
      if (!currentGameData || currentGameData.currentPhase === 'setup') return;
      const player = currentGameData.players.find(p => p.id === playerId);
      const isNight = currentGameData.currentPhase === 'night';

      if (!isNight) {
        if (!player.isAlive) return;

        const isSheriff = player.isSheriff;
        openModal(`
                    <div class="text-center p-4">
                        <h3 class="text-lg font-bold text-white mb-4">Xử lý ${player.name}?</h3>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <button onclick="closeModal()" class="py-2 bg-slate-700 rounded-lg">Hủy</button>
                            <button onclick="executeDayKill('${playerId}', '${player.name}')" class="py-2 bg-red-600 rounded-lg font-bold">Treo Cổ</button>
                        </div>
                        <button onclick="setSheriff('${playerId}', ${!isSheriff})" class="w-full py-3 ${isSheriff ? 'bg-slate-700 text-slate-300' : 'bg-yellow-500 hover:bg-yellow-400 text-black'} font-bold rounded-lg flex items-center justify-center gap-2 transition-colors">
                            <i data-lucide="${isSheriff ? 'minus-circle' : 'star'}" class="w-5 h-5"></i>
                            ${isSheriff ? 'Thu hồi Huy hiệu' : 'Trao Huy hiệu Cảnh Sát Trưởng'}
                        </button>
                    </div>
                `);
        return;
      }

      if (!player.isAlive) return; // Dead players don't act usually

      const roleDef = ROLES.find(r => r.id === player.role.id);

      let actions = roleDef.actions;
      if (player.role.id === 'witch') {
        actions = actions.filter(a => !(player.usedAbilities || []).includes(a.id));
      }

      if (player.role.id === 'thief' && currentGameData.dayCount > 1) {
        openModal(`<div class="text-center p-6"><p class="text-slate-400">Ăn Trộm chỉ hoạt động đêm đầu tiên.</p></div>`);
        return;
      }

      if (!actions.length) {
        openModal(`<div class="text-center p-6"><p class="text-slate-400">Không có hành động đêm (hoặc đã dùng hết).</p></div>`);
        return;
      }

      const buttons = actions.map(a => `
                <button onclick="selectAction('${playerId}', '${a.id}', '${a.label}', '${a.type}')" class="w-full flex items-center justify-between p-3 bg-slate-800 hover:bg-indigo-600/20 border border-slate-700 rounded-xl mb-2">
                    <span class="font-bold text-slate-200">${a.label}</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-500"></i>
                </button>
            `).join('');
      openModal(`<div class="p-2"><h3 class="font-bold text-indigo-400 mb-4 uppercase text-xs">Hành động của ${player.role.name}</h3>${buttons}</div>`);
    }

    function selectAction(actorId, actionId, actionLabel, actionType) {
      modalActorId = actorId;
      modalActionType = actionType;
      const actor = currentGameData.players.find(p => p.id === actorId);

      // ELDER PENALTY CHECK
      if (currentGameData.elderPenaltyActive) {
        // Special roles lose function, EXCEPT Hunter and Wolf team
        const isWolfTeam = ['Sói', 'Sói (Độc lập)'].includes(actor.role.team);
        if (!isWolfTeam && actor.role.id !== 'hunter') {
          openModal(`<div class="text-center p-4 text-slate-400">Chức năng đã bị vô hiệu hóa do Già Làng đã chết!</div>`);
          return;
        }
      }

      // Wolf Bite Limit Check
      if (actionId === 'bite') {
        const count = currentGameData.wolfKillCount || 0;
        const max = currentGameData.maxWolfKills || 1;
        if (count >= max) {
          openModal(`<div class="text-center p-4 text-slate-400">Phe Sói đã hết lượt cắn trong đêm nay! (${count}/${max})</div>`);
          return;
        }
      }

      // CUPID LOGIC
      if (actionType === 'couple') {
        if (currentGameData.dayCount !== 1) {
          openModal(`<div class="text-center p-4 text-slate-400">Thần Tình Yêu chỉ được ghép đôi ở đêm đầu tiên!</div>`);
          return;
        }

        // Check if already coupled
        if (currentGameData.players.some(p => p.isLover)) {
          openModal(`<div class="text-center p-4 text-slate-400">Đã có cặp đôi được ghép! Không thể ghép thêm.</div>`);
          return;
        }

        cupidSelection = [];
        renderCupidSelection(actorId);
        return;
      }

      // PIED PIPER LOGIC
      if (actionType === 'charm') {
        if (actor.lastCharmNight === currentGameData.dayCount) {
          openModal(`<div class="text-center p-4 text-slate-400">Bạn đã thực hiện thôi miên đêm nay rồi!</div>`);
          return;
        }
        charmSelection = [];
        renderCharmSelection(actorId);
        return;
      }

      // FOX LOGIC
      if (actionType === 'scan_three') {
        if (actor.isFoxPowerLost) {
          openModal(`<div class="text-center p-4 text-slate-400">Cáo đã mất năng lực đánh hơi!</div>`);
          return;
        }
        foxSelection = [];
        renderFoxSelection(actorId);
        return;
      }

      // THIEF LOGIC
      if (actionType === 'steal_role') {
        const list = ROLES.map(r => {
          const isWolf = ['Sói', 'Sói (Độc lập)'].includes(r.team);
          return `
                      <button onclick="executeAction('${actor.name}', '${actor.role.name}', '${actionLabel}', '${actionType}', '${r.id}', '${r.name}', '${actionId}')" class="w-full text-left p-3 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-lg flex justify-between mb-2 border border-slate-700">
                          <span>${r.name}</span>
                          <span class="text-xs px-2 py-1 rounded ${isWolf ? 'bg-red-900/30 text-red-400' : 'bg-blue-900/30 text-blue-400'}">${r.team}</span>
                      </button>
                  `
        }).join('');
        openModal(`<div class="p-2"><h3 class="font-bold text-white mb-4">Chọn vai mới (Tất cả)</h3><div class="max-h-[400px] overflow-y-auto custom-scrollbar">${list}</div></div>`);
        return;
      }

      // HYBRID WOLF LOGIC
      if (actionType === 'choose_side') {
        if (currentGameData.dayCount > 1) {
          openModal(`<div class="text-center p-4 text-slate-400">Sói Lai chỉ chọn phe vào đêm đầu tiên!</div>`);
          return;
        }
        openModal(`
            <div class="text-center p-4">
                <h3 class="text-lg font-bold text-amber-500 mb-2">Chọn phe</h3>
                <p class="text-slate-400 text-sm mb-6">Quyết định số phận của bạn...</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="executeSideChoice('${actorId}', 'villager')" class="p-4 bg-blue-600/20 border border-blue-500 hover:bg-blue-600/40 rounded-xl flex flex-col items-center gap-2 transition-all group">
                        <i data-lucide="user" class="w-8 h-8 text-blue-400 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold text-blue-200">Dân Làng</span>
                    </button>
                    <button onclick="executeSideChoice('${actorId}', 'werewolf')" class="p-4 bg-red-600/20 border border-red-500 hover:bg-red-600/40 rounded-xl flex flex-col items-center gap-2 transition-all group">
                        <i data-lucide="moon" class="w-8 h-8 text-red-400 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold text-red-200">Ma Sói</span>
                    </button>
                </div>
            </div>
          `);
        return;
      }

      let targets = currentGameData.players.filter(p => p.isAlive);
      if (actionType === 'revive') targets = currentGameData.players.filter(p => !p.isAlive);

      if ((actor.role.id === 'werewolf' || actor.role.id === 'wolf_cub' || actor.role.id === 'white_wolf') && actionId === 'bite') {
        targets = targets.filter(p => !['Sói', 'Sói (Độc lập)'].includes(p.role.team));
      }
      if (actionType === 'kill_wolf') {
        if (currentGameData.dayCount % 2 !== 0) {
          openModal(`<div class="text-center p-4 text-slate-400">Sói Trắng chỉ được cắn Sói khác vào đêm chẵn (2, 4, 6...)!</div>`);
          return;
        }
        targets = targets.filter(p => p.id !== actorId && ['Sói', 'Sói (Độc lập)'].includes(p.role.team));
      }

      if (!targets.length) {
        openModal(`<div class="text-center p-4 text-slate-400">Không có mục tiêu phù hợp.</div>`);
        return;
      }

      const list = targets.map(t => `
                      <button onclick="executeAction('${actor.name}', '${actor.role.name}', '${actionLabel}', '${actionType}', '${t.id}', '${t.name}', '${actionId}')" class="w-full text-left p-3 hover:bg-slate-700 rounded-lg flex justify-between">
                          <span class="text-slate-200">${t.name}</span>
                          <span class="text-xs bg-slate-900 px-2 py-1 rounded text-slate-500">${t.role.name}</span>
                      </button>
                  `).join('');
      openModal(`<div class="h-[400px] flex flex-col"><h3 class="shrink-0 font-bold text-white mb-2">Chọn mục tiêu</h3><div class="overflow-y-auto custom-scrollbar">${list}</div></div>`);
    }

    function renderCharmSelection(actorId) {
      // Filter out dead players, the piper themselves, and already charmed players
      const targets = currentGameData.players.filter(p => p.isAlive && p.id !== actorId && !p.isCharmed);
      const count = charmSelection.length;
      const limitReached = count >= 2;

      const list = targets.map(t => {
        const isSelected = charmSelection.includes(t.id);
        const isDisabled = limitReached && !isSelected;

        return `
                          <button onclick="${isDisabled ? '' : `toggleCharmSelect('${t.id}', '${actorId}')`}" 
                              class="w-full text-left p-3 border rounded-lg flex justify-between mb-2 transition-colors ${isSelected
            ? 'bg-yellow-600/30 border-yellow-500 hover:border-yellow-400'
            : (isDisabled
              ? 'bg-slate-800/50 border-slate-800 text-slate-600 cursor-not-allowed'
              : 'bg-slate-800 border-slate-700 hover:border-yellow-500 text-slate-200')
          }">
                              <span>${t.name}</span>
                              ${isSelected ? '<i data-lucide="music" class="w-4 h-4 text-yellow-400"></i>' : ''}
                          </button>
                      `
      }).join('');

      const canConfirm = count > 0 && count <= 2;

      openModal(`
                      <div class="h-[500px] flex flex-col">
                          <h3 class="shrink-0 font-bold text-yellow-400 mb-2 uppercase text-xs">Thôi miên (${count}/2)</h3>
                          <div class="overflow-y-auto custom-scrollbar flex-1 mb-4">
                              ${list.length ? list : '<p class="text-slate-500 text-center italic mt-10">Không còn ai để thôi miên...</p>'}
                          </div>
                          <button onclick="${canConfirm ? `executeCharmConfirm('${actorId}')` : ''}" class="w-full py-3 rounded-xl font-bold transition-colors ${canConfirm ? 'bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg shadow-yellow-900/40' : 'bg-slate-800 text-slate-600 cursor-not-allowed'}">
                              Xác nhận
                          </button>
                      </div>
                  `);
    }
    function toggleCharmSelect(targetId, actorId) {
      if (charmSelection.includes(targetId)) {
        charmSelection = charmSelection.filter(id => id !== targetId);
      } else {
        if (charmSelection.length < 2) charmSelection.push(targetId);
      }
      renderCharmSelection(actorId);
    }

    function executeCharmConfirm(actorId) {
      closeModal();
      if (charmSelection.length === 0) return;

      // Strict enforcement: Take only up to 2 players
      const finalSelection = charmSelection.slice(0, 2);

      let players = currentGameData.players.map(p => ({ ...p }));
      let revertData = [];
      let charmedNames = [];

      // Mark the Piper as having acted this night
      const actorIndex = players.findIndex(p => p.id === actorId);
      if (actorIndex !== -1) {
        revertData.push({ id: actorId, changes: { lastCharmNight: players[actorIndex].lastCharmNight } });
        players[actorIndex].lastCharmNight = currentGameData.dayCount;
      }

      finalSelection.forEach(tid => {
        const target = players.find(p => p.id === tid);
        if (target) {
          revertData.push({ id: tid, changes: { isCharmed: false } });
          target.isCharmed = true;
          charmedNames.push(target.name);
        }
      });

      const logText = `🎶 Thổi Sáo đã thôi miên: ${charmedNames.join(', ')}`;
      pushLogInternal(logText, revertData);
      pushLogInternal("🔔 GM: Hãy gọi những người bị thôi miên dậy để nhận mặt nhau.", []);

      updateGameData({ players });
      checkWinCondition(players);
    }

    // --- Fox Selection UI ---
    function renderFoxSelection(actorId) {
      const targets = currentGameData.players.filter(p => p.isAlive && p.id !== actorId);
      const list = targets.map(t => {
        const isSelected = foxSelection.includes(t.id);
        const isDisabled = foxSelection.length >= 3 && !isSelected;
        return `
            <button onclick="${isDisabled ? '' : `toggleFoxSelect('${t.id}', '${actorId}')`}" class="w-full text-left p-3 ${isSelected ? 'bg-orange-600/30 border-orange-500' : 'bg-slate-800 border-slate-700'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''} border rounded-lg flex justify-between mb-2 hover:border-orange-500 transition-colors">
                <span class="text-slate-200">${t.name}</span>
                ${isSelected ? '<i data-lucide="radar" class="w-4 h-4 text-orange-400"></i>' : ''}
            </button>
        `}).join('');

      const canConfirm = foxSelection.length === 3;

      openModal(`
            <div class="h-[500px] flex flex-col">
                <h3 class="shrink-0 font-bold text-orange-400 mb-2 uppercase text-xs">Cáo ngửi (Chọn 3 người)</h3>
                <div class="overflow-y-auto custom-scrollbar flex-1 mb-4">
                    ${list}
                </div>
                <button onclick="${canConfirm ? `executeFoxConfirm('${actorId}')` : ''}" class="w-full py-3 rounded-xl font-bold transition-colors ${canConfirm ? 'bg-orange-600 hover:bg-orange-500 text-white shadow-lg shadow-orange-900/40' : 'bg-slate-800 text-slate-600 cursor-not-allowed'}">
                    Xác nhận
                </button>
            </div>
        `);
    }

    function toggleFoxSelect(targetId, actorId) {
      if (foxSelection.includes(targetId)) {
        foxSelection = foxSelection.filter(id => id !== targetId);
      } else {
        if (foxSelection.length < 3) foxSelection.push(targetId);
      }
      renderFoxSelection(actorId);
    }

    function executeFoxConfirm(actorId) {
      closeModal();
      if (foxSelection.length !== 3) return;

      // Get fresh state reference for modification
      let players = currentGameData.players.map(p => ({ ...p }));
      let revertData = [];

      const actorIndex = players.findIndex(p => p.id === actorId);
      if (actorIndex === -1) return;
      const actor = players[actorIndex];

      // Check if any selected player is a Wolf
      const targets = players.filter(p => foxSelection.includes(p.id));
      const hasWolf = targets.some(p => ['Sói', 'Sói (Độc lập)'].includes(p.role.team));

      let logText = `🦊 Cáo đã ngửi 3 người: ${targets.map(p => p.name).join(', ')}.`;
      let alertMsg = "";

      if (hasWolf) {
        logText += " => CÓ SÓI! (Cáo giữ năng lực)";
        alertMsg = "🦊 CÓ SÓI trong nhóm này! Cáo giữ nguyên năng lực.";
        // Ensure isFoxPowerLost is NOT set (redundant but safe)
      } else {
        logText += " => KHÔNG CÓ SÓI! (Cáo mất năng lực)";
        revertData.push({ id: actorId, changes: { isFoxPowerLost: actor.isFoxPowerLost || false } });
        actor.isFoxPowerLost = true;
        alertMsg = "🦊 KHÔNG CÓ SÓI! Cáo đã mất năng lực.";
      }

      // Create log entry manually for atomic update
      const phase = currentGameData.currentPhase === 'night' ? `Đêm ${currentGameData.dayCount}` : `Ngày ${currentGameData.dayCount}`;
      const newLog = {
        id: crypto.randomUUID(),
        time: new Date().toISOString(),
        phase,
        text: logText,
        revertData
      };

      // Atomic Update: Get latest logs, append new one, and update players simultaneously
      // This prevents race conditions between log updates and player updates
      const currentLogs = getStoredGames().find(g => g.id === activeGameId)?.logs || [];
      const updatedLogs = [...currentLogs, newLog];

      updateGameData({ players: players, logs: updatedLogs });

      setTimeout(() => alert(alertMsg), 100);
    }

    function executeSideChoice(actorId, choice) {
      closeModal();
      let players = currentGameData.players.map(p => ({ ...p }));
      let revertData = [];
      const actorIndex = players.findIndex(p => p.id === actorId);
      if (actorIndex === -1) return;
      const actor = players[actorIndex];

      let logText = "";

      revertData.push({ id: actorId, changes: { role: actor.role } });

      if (choice === 'werewolf') {
        // Become Werewolf
        const werewolfRole = ROLES.find(r => r.id === 'werewolf');
        // We keep the name "Sói Lai" but change team and maybe add indicator
        // Or strictly change role? User request: "trở thành ... Ma sói"
        // Let's change Team primarily.
        actor.role = { ...actor.role, team: 'Sói', name: 'Sói Lai (Sói)' };
        logText = `🐶 Sói Lai ${actor.name} đã chọn theo phe SÓI!`;
      } else {
        // Stay Villager
        actor.role = { ...actor.role, team: 'Dân', name: 'Sói Lai (Dân)' };
        logText = `🐶 Sói Lai ${actor.name} đã chọn theo phe DÂN!`;
      }

      // Atomic update pattern
      const phase = currentGameData.currentPhase === 'night' ? `Đêm ${currentGameData.dayCount}` : `Ngày ${currentGameData.dayCount}`;
      const newLog = {
        id: crypto.randomUUID(),
        time: new Date().toISOString(),
        phase,
        text: logText,
        revertData
      };

      const currentLogs = getStoredGames().find(g => g.id === activeGameId)?.logs || [];
      const updatedLogs = [...currentLogs, newLog];

      updateGameData({ players: players, logs: updatedLogs });
    }

    // --- Cupid Selection UI ---
    function renderCupidSelection(actorId) {
      const targets = currentGameData.players.filter(p => p.isAlive);
      const list = targets.map(t => {
        const isSelected = cupidSelection.includes(t.id);
        return `
                <button onclick="toggleCupidSelect('${t.id}', '${actorId}')" class="w-full text-left p-3 ${isSelected ? 'bg-pink-600/30 border-pink-500' : 'bg-slate-800 border-slate-700'} border rounded-lg flex justify-between mb-2 hover:border-pink-500 transition-colors">
                    <span class="text-slate-200">${t.name}</span>
                    ${isSelected ? '<i data-lucide="heart" class="w-4 h-4 text-pink-400"></i>' : ''}
                </button>
            `}).join('');

      const canConfirm = cupidSelection.length === 2;

      openModal(`
                <div class="h-[500px] flex flex-col">
                    <h3 class="shrink-0 font-bold text-pink-400 mb-2 uppercase text-xs">Ghép đôi (Chọn 2 người)</h3>
                    <div class="overflow-y-auto custom-scrollbar flex-1 mb-4">
                        ${list}
                    </div>
                    <button onclick="${canConfirm ? `executeCupidConfirm('${actorId}')` : ''}" class="w-full py-3 rounded-xl font-bold transition-colors ${canConfirm ? 'bg-pink-600 hover:bg-pink-500 text-white shadow-lg shadow-pink-900/40' : 'bg-slate-800 text-slate-600 cursor-not-allowed'}">
                        Xác nhận ghép đôi
                    </button>
                </div>
            `);
    }

    function toggleCupidSelect(targetId, actorId) {
      if (cupidSelection.includes(targetId)) {
        cupidSelection = cupidSelection.filter(id => id !== targetId);
      } else {
        if (cupidSelection.length < 2) cupidSelection.push(targetId);
      }
      renderCupidSelection(actorId);
    }

    function setSheriff(playerId, status) {
      closeModal();
      let players = currentGameData.players.map(p => ({ ...p }));
      let revertData = [];
      const target = players.find(p => p.id === playerId);

      if (status) {
        // Unset any existing Sheriff
        players.forEach(p => {
          if (p.isSheriff) {
            revertData.push({ id: p.id, changes: { isSheriff: true } });
            p.isSheriff = false;
          }
        });
        // Set new Sheriff
        revertData.push({ id: target.id, changes: { isSheriff: false } });
        target.isSheriff = true;
        pushLogInternal(`⭐️ ${target.name} đã trở thành Cảnh sát trưởng!`, revertData);
      } else {
        revertData.push({ id: target.id, changes: { isSheriff: true } });
        target.isSheriff = false;
        pushLogInternal(`🚫 ${target.name} không còn là Cảnh sát trưởng.`, revertData);
      }

      updateGameData({ players });
    }

    function executeCupidConfirm(actorId) {
      closeModal();
      if (cupidSelection.length !== 2) return;

      // Create a deep copy of players to avoid reference issues
      let newPlayers = currentGameData.players.map(p => ({ ...p }));

      const p1Index = newPlayers.findIndex(p => p.id === cupidSelection[0]);
      const p2Index = newPlayers.findIndex(p => p.id === cupidSelection[1]);

      const p1 = newPlayers[p1Index];
      const p2 = newPlayers[p2Index];

      // Generate Revert Data
      const revertData = [
        { id: p1.id, changes: { isLover: false, loverId: null } },
        { id: p2.id, changes: { isLover: false, loverId: null } }
      ];

      // Apply changes
      p1.isLover = true;
      p1.loverId = p2.id;
      p2.isLover = true;
      p2.loverId = p1.id;

      const logText = `💘 Thần Tình Yêu đã ghép đôi: ${p1.name} ❤️ ${p2.name}`;
      pushLogInternal(logText, revertData);

      // Save the NEW players array
      updateGameData({ players: newPlayers });
    }

    function renderSheriffTransferModal(deadSheriffId) {
      if (!currentGameData) return;
      const candidates = currentGameData.players.filter(p => p.isAlive && p.id !== deadSheriffId);

      if (candidates.length === 0) return; // Game likely over

      const list = candidates.map(c => `
            <button onclick="transferSheriff('${c.id}', '${deadSheriffId}')" class="w-full text-left p-3 bg-slate-800 hover:bg-yellow-500/20 border border-slate-700 hover:border-yellow-500 rounded-lg flex justify-between mb-2 group transition-all">
                <span class="text-slate-200 font-bold group-hover:text-yellow-200">${c.name}</span>
                <i data-lucide="star" class="w-4 h-4 text-slate-600 group-hover:text-yellow-400"></i>
            </button>
        `).join('');

      openModal(`
            <div class="h-[400px] flex flex-col p-2">
                <div class="text-center mb-4">
                    <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-2">
                         <i data-lucide="star" class="w-6 h-6 text-yellow-500"></i>
                    </div>
                    <h3 class="font-bold text-lg text-white">Chuyển quyền Cảnh Sát Trưởng</h3>
                    <p class="text-sm text-slate-400">Chọn người kế thừa huy hiệu</p>
                </div>
                <div class="overflow-y-auto custom-scrollbar flex-1">
                    ${list}
                </div>
            </div>
        `);
    }

    function transferSheriff(newSheriffId, oldSheriffId) {
      closeModal();
      let players = currentGameData.players.map(p => ({ ...p }));
      let revertData = [];

      const newSheriff = players.find(p => p.id === newSheriffId);
      const oldSheriff = players.find(p => p.id === oldSheriffId);

      if (oldSheriff) {
        revertData.push({ id: oldSheriffId, changes: { isSheriff: true } });
        oldSheriff.isSheriff = false;
      }

      if (newSheriff) {
        revertData.push({ id: newSheriffId, changes: { isSheriff: false } });
        newSheriff.isSheriff = true;
        pushLogInternal(`⭐️ Huy hiệu đã được trao cho ${newSheriff.name}`, revertData);
      }

      updateGameData({ players });
    }

    // --- Helper to Kill Player (Handles recursive lover death) ---
    function killPlayer(player, playersList, currentChangesLog) {
      if (!player.isAlive) return;

      if (player.isSheriff) {
        pushLogInternal(`⚠️ Cảnh sát trưởng ${player.name} đã chết! Hãy chuyển quyền cho người khác.`);
      }

      // Record current state for revert
      currentChangesLog.push({
        id: player.id,
        changes: { isAlive: true, elderLives: player.elderLives, revealed: player.revealed, deathPhase: player.deathPhase }
      });

      // Modify State
      player.isAlive = false;
      // Record when they died (e.g., 'night_1', 'day_2')
      player.deathPhase = `${currentGameData.currentPhase}_${currentGameData.dayCount}`;

      // Check Lover
      if (player.loverId) {
        const partner = playersList.find(p => p.id === player.loverId);
        if (partner && partner.isAlive) {
          killPlayer(partner, playersList, currentChangesLog); // Recursive kill
        }
      }
    }

    function checkDeadSheriff(players) {
      // Find if there is a dead sheriff that hasn't transferred title yet (implicitly checked by them still having isSheriff=true)
      // However, killPlayer does NOT clear isSheriff. So a dead player with isSheriff=true means they died holding it.
      const deadSheriff = players.find(p => !p.isAlive && p.isSheriff);
      if (deadSheriff) {
        renderSheriffTransferModal(deadSheriff.id);
      }
    }

    function executeAction(actorName, actorRole, actionLabel, actionType, targetId, targetName, actionId) {
      closeModal();
      let log = `${actorName} (${actorRole}) đã ${actionLabel} ${targetName}`;

      // Use deep copy to ensure recursive changes in killPlayer persist correctly
      let players = currentGameData.players.map(p => ({ ...p }));
      let target = players.find(p => p.id === targetId);
      let updates = {};
      let revertData = [];

      // Track Ability Usage (Witch)
      const actor = players.find(p => p.id === modalActorId);
      if (actor && actor.role.id === 'witch' && actionId) {
        if (!actor.usedAbilities) actor.usedAbilities = [];
        revertData.push({ id: actor.id, changes: { usedAbilities: [...actor.usedAbilities] } });
        actor.usedAbilities.push(actionId);
      }

      // Logic
      if (actionType === 'protect') {
        if (currentGameData.lastProtectedId === targetId) { alert("Không thể bảo vệ 2 đêm liên tiếp!"); return; }

        // Revert data for global state
        revertData.push({ global: true, changes: { protectedId: currentGameData.protectedId, lastProtectedId: currentGameData.lastProtectedId } });

        updates.protectedId = targetId;
        updates.lastProtectedId = targetId;
        log += " 🛡️";
      } else if (actionType === 'steal_role') {
        if (!actor) return;
        const newRole = ROLES.find(r => r.id === targetId);

        revertData.push({ id: actor.id, changes: { role: actor.role, elderLives: actor.elderLives, originalRole: actor.originalRole } });

        actor.originalRole = { ...actor.role };
        actor.role = { id: newRole.id, name: newRole.name, team: newRole.team };
        if (actor.role.id === 'elder') actor.elderLives = 2;

        log += ` đã đổi vai thành ${newRole.name}`;
      } else if (actionType === 'hunter_aim') {
        updates.hunterTargetId = targetId;
        log += " 🎯 (Đã ghim)";
      } else if (actionType === 'kill' || actionType === 'kill_wolf') {
        // Identify Actor Role
        const isWitchPoison = actor && actor.role.id === 'witch';

        if (targetId === currentGameData.protectedId && !isWitchPoison) {
          log += " 🛡️ (Được bảo vệ)";
        } else {
          const actorRoleId = actor ? actor.role.id : '';
          const isWolfAttack = ['werewolf', 'wolf_cub', 'white_wolf'].includes(actorRoleId);

          // Track Wolf Kills (Only standard bite)
          if (isWolfAttack && actionType === 'kill') {
            revertData.push({ global: true, changes: { wolfKillCount: currentGameData.wolfKillCount || 0 } });
            updates.wolfKillCount = (currentGameData.wolfKillCount || 0) + 1;
          }

          // Elder Logic
          if (target.role.id === 'elder') {
            if (isWolfAttack && target.elderLives > 1) {
              revertData.push({ id: target.id, changes: { elderLives: target.elderLives } });
              target.elderLives--;
              log += " (Mất 1 mạng)";
            } else {
              // Dies (Run out of lives OR killed by Witch/Hunter)

              // Trigger Penalty (Modified: Always trigger when Elder dies, regardless of attacker)
              revertData.push({ global: true, changes: { elderPenaltyActive: currentGameData.elderPenaltyActive } });
              updates.elderPenaltyActive = true;
              pushLogInternal("⚠️ Già Làng đã chết! Các chức năng đặc biệt bị vô hiệu hóa.", []);

              const initialRevertLength = revertData.length;
              killPlayer(target, players, revertData);
              if (revertData.length > initialRevertLength + 1) {
                log += " 💀 (Và người tình cũng chết theo!)";
              } else {
                log += " 💀";
              }
            }
          } else if (target.role.id === 'rusty_sword_knight' && isWolfAttack) {
            // Rusty Sword Knight Logic
            if (actor) {
              revertData.push({ id: actor.id, changes: { rustySwordDeathDay: actor.rustySwordDeathDay } });
              actor.rustySwordDeathDay = currentGameData.dayCount + 1;
              pushLogInternal(`⚔️ ${actor.name} đã cắn Hiệp sĩ kiếm gỉ! Sẽ chết vào sáng Ngày ${currentGameData.dayCount + 1}.`, []);
            }

            const initialRevertLength = revertData.length;
            killPlayer(target, players, revertData);
            if (revertData.length > initialRevertLength + 1) {
              log += " 💀 (Và người tình cũng chết theo!)";
            } else {
              log += " 💀";
            }
          } else if (target.role.id === 'cursed' && target.role.team === 'Dân' && isWolfAttack) {
            revertData.push({ id: target.id, changes: { role: target.role, originalRole: target.originalRole } });
            target.originalRole = { ...target.role };
            const werewolfRole = ROLES.find(r => r.id === 'werewolf');
            target.role = { id: werewolfRole.id, name: werewolfRole.name, team: werewolfRole.team };
            log += " 🐺 (Đã hóa Sói)";
          } else {
            // Angel Logic (Night 1 Wolf Attack)
            if (target.role.id === 'angel' && currentGameData.dayCount === 1 && isWolfAttack) {
              killPlayer(target, players, revertData);
              pushLogInternal(`👼 ${target.name} (Thiên Sứ) đã bị Sói cắn và hoàn thành nhiệm vụ!`, revertData);
              updateGameData({ players, ...updates });
              setTimeout(() => { alert("THIÊN SỨ THẮNG! 👼"); finishGame(); }, 100);
              return;
            }

            // Kill Logic with Lover Check
            const initialRevertLength = revertData.length;
            killPlayer(target, players, revertData);

            // Hunter Logic (Night Death by Wolf)
            let extraMsg = "";
            if (target.role.id === 'hunter' && isWolfAttack && currentGameData.hunterTargetId) {
              const hunterTarget = players.find(p => p.id === currentGameData.hunterTargetId);
              if (hunterTarget && hunterTarget.isAlive) {
                killPlayer(hunterTarget, players, revertData);
                extraMsg = ` 🔫 (Kéo theo ${hunterTarget.name})`;
              }
            }

            // If more than 1 person died (due to lover), append to log
            if (revertData.length > initialRevertLength + 1) {
              log += extraMsg || " 💀 (Và người tình cũng chết theo!)";
            } else {
              log += " 💀";
            }

            if (target.role.id === 'wolf_cub') {
              revertData.push({ global: true, changes: { nextNightExtraKills: currentGameData.nextNightExtraKills } });
              updates.nextNightExtraKills = 1;
              pushLogInternal("⚠️ Sói Con đã chết! Đêm mai Sói được cắn 2 người.", []); // Separate log, hard to revert automatically without linking. Kept simple.
            }
          }
        }
      } else if (actionType === 'revive') {
        revertData.push({ id: target.id, changes: { isAlive: false } });
        target.isAlive = true;
        log += " ✨";
      } else if (actionType === 'charm') {
        revertData.push({ id: target.id, changes: { isCharmed: false } });
        target.isCharmed = true;
        log += " 🎶 (Bị thôi miên)";
      }

      pushLogInternal(log, revertData);
      updateGameData({ players, ...updates });
      checkWinCondition(players);
      checkDeadSheriff(players);
    }

    function executeDayKill(playerId, playerName) {
      closeModal();
      // Use deep copy here too
      let players = currentGameData.players.map(p => ({ ...p }));
      let target = players.find(p => p.id === playerId);
      let revertData = [];

      // Idiot Logic
      if (target.role.id === 'idiot' && !target.revealed && !currentGameData.elderPenaltyActive) {
        revertData.push({ id: target.id, changes: { revealed: false } });
        target.revealed = true;
        pushLogInternal(`🤡 ${playerName} là Thằng Ngốc! Hắn không chết nhưng mất quyền biểu quyết.`, revertData);
      } else {
        // Angel Logic (Day 1 Hanging)
        if (target.role.id === 'angel' && currentGameData.dayCount === 1) {
          killPlayer(target, players, revertData);
          pushLogInternal(`⚖️ ${playerName} (Thiên Sứ) đã bị TREO CỔ và hoàn thành nhiệm vụ!`, revertData);
          updateGameData({ players });
          setTimeout(() => { alert("THIÊN SỨ THẮNG! 👼"); finishGame(); }, 100);
          return;
        }

        // Elder Logic for Hanging
        if (target.role.id === 'elder') {
          revertData.push({ global: true, changes: { elderPenaltyActive: currentGameData.elderPenaltyActive } });
          pushLogInternal("⚠️ Già Làng bị treo cổ! Các chức năng đặc biệt bị vô hiệu hóa.", []);
          updateGameData({ elderPenaltyActive: true });
        }

        // Hunter Logic
        if (target.role.id === 'hunter') {
          pushLogInternal("🔫 Thợ Săn bị treo cổ! Có quyền chọn 1 người chết cùng.", []);
        }

        killPlayer(target, players, revertData);
        let logText = `⚖️ ${playerName} đã bị TREO CỔ.`;
        if (revertData.length > 1) logText += " (Người tình chết theo)";

        pushLogInternal(logText, revertData);

        if (target.role.id === 'wolf_cub') {
          pushLogInternal("⚠️ Sói Con bị treo cổ! Đêm nay Sói được cắn 2 người.", []);
          updateGameData({ nextNightExtraKills: 1 });
        }
      }
      updateGameData({ players });
      checkWinCondition(players);
      checkDeadSheriff(players);
    }

    function checkWinCondition(players) {
      // Use setTimeout to allow UI to render the death state before alerting
      setTimeout(() => {
        const alive = players.filter(p => p.isAlive);
        const wolves = alive.filter(p => ['Sói', 'Sói (Độc lập)'].includes(p.role.team)).length;
        const nonWolves = alive.length - wolves;
        const piper = alive.find(p => p.role.id === 'pied_piper');

        let winner = null;

        // Pied Piper Win
        if (piper) {
          const uncharmed = alive.filter(p => !p.isCharmed && p.role.id !== 'pied_piper');
          if (uncharmed.length === 0) {
            winner = "KẺ THỔI SÁO THẮNG! 🎶";
          }
        }
        // White Wolf Win
        const whiteWolf = alive.find(p => p.role.id === 'white_wolf');
        if (!winner && whiteWolf && alive.length === 1) {
          winner = "SÓI TRẮNG THẮNG! 🐺⚪";
        }

        // Couple Win (3rd Party Mixed)
        if (!winner && alive.length === 2) {
          const [p1, p2] = alive;
          if (p1.loverId === p2.id && p1.role.team !== p2.role.team) {
            winner = "CẶP ĐÔI KHÁC PHE THẮNG! ❤️";
          }
        }

        if (!winner) {
          if (wolves === 0) winner = "PHE DÂN THẮNG! 🏆";
          else if (wolves >= nonWolves) winner = "PHE SÓI THẮNG! 🐺";
        }

        if (winner) {
          pushLogInternal(`🏆 KẾT THÚC: ${winner}`);
          alert(winner);
          finishGame();
        }
      }, 100);
    }

    // --- Common Utils & Log Management ---
    function pushLogInternal(text, revertData = []) {
      const phase = currentGameData.currentPhase === 'night' ? `Đêm ${currentGameData.dayCount}` : `Ngày ${currentGameData.dayCount}`;
      const newLog = {
        id: crypto.randomUUID(),
        time: new Date().toISOString(),
        phase,
        text,
        revertData // Store how to undo this log
      };
      updateGameData({ logs: [...(currentGameData.logs || []), newLog] });
    }

    function confirmDeleteLog(logId) {
      openModal(`
                <div class="text-center p-4">
                    <h3 class="text-lg font-bold text-white mb-2">Xóa Log & Hoàn tác?</h3>
                    <p class="text-slate-400 text-sm mb-4">Hành động này sẽ xóa dòng nhật ký và <b>trả lại trạng thái cũ</b> của người chơi.</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeModal()" class="py-2 bg-slate-700 rounded-lg">Hủy</button>
                        <button onclick="executeDeleteLog('${logId}')" class="py-2 bg-red-600 rounded-lg font-bold shadow-lg shadow-red-900/40">Xóa & Revert</button>
                    </div>
                </div>
            `);
    }

    function executeDeleteLog(logId) {
      closeModal();
      if (!currentGameData) return;

      const log = currentGameData.logs.find(l => l.id === logId);
      if (!log) return;

      let players = [...currentGameData.players];
      let updates = {};

      // Apply Revert Data
      if (log.revertData && Array.isArray(log.revertData)) {
        log.revertData.forEach(item => {
          if (item.global) {
            // Restore global properties
            Object.assign(updates, item.changes);
          } else {
            // Restore player properties
            const pIndex = players.findIndex(p => p.id === item.id);
            if (pIndex !== -1) {
              players[pIndex] = { ...players[pIndex], ...item.changes };
            }
          }
        });
      }

      const updatedLogs = currentGameData.logs.filter(l => l.id !== logId);
      updateGameData({ players, logs: updatedLogs, ...updates });
    }

    function updateGameData(updates) {
      if (!activeGameId) return;
      const games = getStoredGames();
      const idx = games.findIndex(g => g.id === activeGameId);
      if (idx !== -1) {
        games[idx] = { ...games[idx], ...updates };
        saveStoredGames(games);
        currentGameData = games[idx];
        renderGameUI();
      }
    }

    function nextPhase() {
      if (!currentGameData) return;
      checkWinCondition(currentGameData.players);
      let { currentPhase, dayCount, nextNightExtraKills } = currentGameData;
      let updates = {};
      if (currentPhase === 'setup') {
        currentPhase = 'night';
        updates.protectedId = null;
        updates.hunterTargetId = null;
        updates.wolfKillCount = 0;
        updates.maxWolfKills = 1;
        pushLogInternal(`🌑 MÀN ĐÊM BUÔNG XUỐNG (Đêm ${dayCount})`);
      } else if (currentPhase === 'night') {
        currentPhase = 'day';
        pushLogInternal(`☀️ TRỜI ĐÃ SÁNG (Ngày ${dayCount})`);

        let players = [...currentGameData.players];
        let hasUpdates = false;

        // Check Hybrid Wolf Default Choice (End of Night 1)
        if (dayCount === 1) {
          players = players.map(p => {
            if (p.role.id === 'hybrid_wolf' && p.role.name === 'Sói Lai') {
              hasUpdates = true;
              // Default to Villager
              pushLogInternal(`🐶 ${p.name} (Sói Lai) không chọn phe => Mặc định là Dân.`);
              return { ...p, role: { ...p.role, team: 'Dân', name: 'Sói Lai (Dân)' } };
            }
            return p;
          });
        }

        // Check Rusty Sword Deaths
        const deadWolves = players.filter(p => p.isAlive && p.rustySwordDeathDay === dayCount);
        if (deadWolves.length > 0) {
          hasUpdates = true;
          let revertData = [];
          // Note: killPlayer modifies 'players' in place if passed the array reference? 
          // killPlayer implementation: killPlayer(player, playersList, currentChangesLog)
          // It modifies 'player.isAlive' etc. Since we mapped players above, we are working on a copy if mapped, or original if not.
          // Wait, players = [...currentGameData.players] is a shallow copy of the array, but elements are references.
          // But above I did players.map(...) which creates new objects for modified ones.
          // But for unmodified ones, they are still references to 'currentGameData.players' objects if I didn't deep copy?
          // Actually, best to deep copy at start of complex phase change logic.
          // Let's refine the top block.

          deadWolves.forEach(w => {
            const target = players.find(p => p.id === w.id); // Re-find in potentially modified list
            if (target) {
              killPlayer(target, players, revertData);
              pushLogInternal(`☠️ ${target.name} đã chết do vết thương từ Hiệp sĩ kiếm gỉ!`, revertData);
            }
          });
        }

        if (hasUpdates) updates.players = players;

      } else {
        // Angel Failure Check (End of Day 1)
        if (currentPhase === 'day' && dayCount === 1) {
          let players = [...currentGameData.players];
          const angelIdx = players.findIndex(p => p.role.id === 'angel' && p.isAlive);
          if (angelIdx !== -1) {
            players[angelIdx] = {
              ...players[angelIdx],
              originalRole: { ...players[angelIdx].role },
              role: { id: 'villager', name: 'Dân Làng', team: 'Dân' }
            };
            updates.players = players;
            pushLogInternal("👼 Thiên Sứ không chết ngày đầu, trở thành Dân Làng!");
          }
        }

        currentPhase = 'night';
        dayCount++;
        updates.protectedId = null;
        updates.hunterTargetId = null;
        updates.wolfKillCount = 0;
        updates.maxWolfKills = 1;
        if (nextNightExtraKills > 0) {
          pushLogInternal(`⚠️ Đêm nay Sói được cắn thêm ${nextNightExtraKills} người!`);
          updates.maxWolfKills = 1 + nextNightExtraKills;
          updates.nextNightExtraKills = 0;
        }
        pushLogInternal(`🌑 MÀN ĐÊM BUÔNG XUỐNG (Đêm ${dayCount})`);
      }
      updateGameData({ currentPhase, dayCount, ...updates });
    }

    // --- Standard UI Helpers ---
    function loadGamesList() {
      const listEl = document.getElementById('games-list'); listEl.innerHTML = '';
      const games = getStoredGames().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      if (!games.length) listEl.innerHTML = `<div class="text-center col-span-full py-10 opacity-50">Chưa có ván đấu</div>`;
      games.forEach(g => {
        const el = document.createElement('div');
        el.className = 'glass-panel p-5 rounded-xl cursor-pointer hover:border-indigo-500 transition-all group';
        el.onclick = () => loadGame(g.id);

        const isFinished = g.status === 'finished';
        const badgeClass = isFinished ? 'bg-slate-700 text-slate-300' : 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30';

        el.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <span class="font-bold text-lg text-slate-200 group-hover:text-indigo-400 transition-colors">#${g.id.substring(0, 6)}</span>
                <span class="text-[10px] font-bold uppercase ${badgeClass} px-2 py-1 rounded tracking-wider">${isFinished ? 'Kết thúc' : 'Đang chơi'}</span>
            </div>
            <div class="text-sm text-slate-400 mb-4 flex items-center gap-2">
                <i data-lucide="calendar" class="w-3 h-3"></i>
                ${new Date(g.createdAt).toLocaleDateString('vi-VN')}
                <span class="mx-1">•</span>
                <i data-lucide="users" class="w-3 h-3"></i>
                ${g.players.length} người
            </div>
            <div class="flex items-center gap-3 pt-3 border-t border-white/5">
                 ${isFinished ? `
                 <button onclick="event.stopPropagation();viewGameReport('${g.id}')" class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded flex items-center gap-1 transition-colors">
                    <i data-lucide="scroll-text" class="w-3 h-3"></i> Tổng kết
                 </button>` : ''}
                 <button onclick="event.stopPropagation();deleteGame(event,'${g.id}')" class="px-3 py-1.5 hover:bg-red-500/10 text-slate-500 hover:text-red-400 text-xs font-bold rounded flex items-center gap-1 transition-colors ml-auto">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> Xóa
                 </button>
            </div>
        `;
        listEl.appendChild(el);
      });
      lucide.createIcons();
    }

    function viewGameReport(gameId) {
      const game = getStoredGames().find(g => g.id === gameId);
      if (!game) return;

      const content = document.getElementById('report-content');

      // --- 1. Header Info ---
      const dateStr = new Date(game.createdAt).toLocaleString('vi-VN');
      const lastLog = game.logs && game.logs.length ? game.logs[game.logs.length - 1] : null;
      let winnerText = "Chưa xác định";
      let winnerColor = "bg-slate-700";

      if (lastLog && lastLog.text.includes("KẾT THÚC:")) {
        winnerText = lastLog.text.replace("🏆 KẾT THÚC:", "").trim();
        if (winnerText.includes("DÂN")) winnerColor = "bg-blue-600";
        else if (winnerText.includes("SÓI")) winnerColor = "bg-red-600";
        else if (winnerText.includes("THỨ 3") || winnerText.includes("TÌNH")) winnerColor = "bg-yellow-600";
      }

      // --- 2. Players Table ---
      const playersHtml = game.players.map(p => {
        const isWolf = ['Sói', 'Sói (Độc lập)'].includes(p.role.team);
        const statusClass = p.isAlive ? '' : 'opacity-50 grayscale';
        const statusText = p.isAlive ? '<span class="text-emerald-400 font-bold">Sống</span>' : `<span class="text-red-400 font-bold">Chết</span> <span class="text-xs text-slate-500">(${p.deathPhase ? p.deathPhase.replace('day_', 'Ngày ').replace('night_', 'Đêm ') : '?'})</span>`;

        let badges = [];
        if (p.isSheriff) badges.push('<span class="text-[10px] border border-yellow-500 text-yellow-500 px-1 rounded">Cảnh sát trưởng</span>');
        if (p.isLover) badges.push('<span class="text-[10px] border border-pink-500 text-pink-500 px-1 rounded">Tình nhân</span>');
        if (p.originalRole) badges.push(`<span class="text-[10px] border border-slate-500 text-slate-500 px-1 rounded" title="Gốc: ${p.originalRole.name}">Biến hình</span>`);

        return `
                <tr class="border-b border-white/5 ${statusClass}">
                    <td class="py-3 pl-2 font-bold text-slate-200">${p.name}</td>
                    <td class="py-3">
                        <div class="flex flex-col">
                            <span class="${isWolf ? 'text-red-300' : 'text-blue-300'} font-medium">${p.role.name}</span>
                            <span class="text-[10px] text-slate-500 uppercase">${p.role.team}</span>
                        </div>
                    </td>
                    <td class="py-3">${statusText}</td>
                    <td class="py-3 pr-2 flex flex-wrap gap-1">${badges.join('')}</td>
                </tr>
            `;
      }).join('');

      // --- 3. Timeline ---
      let timelineHtml = '';
      if (game.logs && game.logs.length) {
        let currentPhase = '';

        // Lọc ra các log của GM
        const filteredLogs = game.logs.filter(log => !log.text.startsWith('🔔 GM:'));

        filteredLogs.forEach(log => {
          const isNewPhase = log.phase !== currentPhase;
          if (isNewPhase) {
            currentPhase = log.phase;
            const isNight = currentPhase.includes('Đêm');
            timelineHtml += `
                        <div class="sticky top-0 z-10 py-2 px-4 mt-6 mb-2 rounded-lg font-bold text-sm uppercase tracking-widest ${isNight ? 'bg-indigo-900/80 text-indigo-200' : 'bg-amber-600/80 text-amber-100'} backdrop-blur-sm border-l-4 ${isNight ? 'border-indigo-400' : 'border-amber-300'} print:bg-slate-200 print:text-black">
                            ${currentPhase}
                        </div>
                    `;
          }

          // Highlight kills/important events
          let itemClass = "text-slate-300 border-l border-slate-700 pl-4 py-2 ml-2 text-sm";
          let icon = "";

          if (log.text.includes("chết") || log.text.includes("TREO CỔ") || log.text.includes("cắn")) {
            itemClass = "text-red-300 border-l-2 border-red-500 pl-4 py-2 ml-2 bg-red-900/10 rounded-r-lg text-sm font-medium";
            icon = "💀 ";
          } else if (log.text.includes("bảo vệ")) {
            itemClass = "text-emerald-300 border-l border-emerald-500 pl-4 py-2 ml-2 text-sm";
          } else if (log.text.includes("Soi")) {
            itemClass = "text-indigo-300 border-l border-indigo-500 pl-4 py-2 ml-2 text-sm";
          }

          timelineHtml += `
                    <div class="${itemClass}">
                        <span class="opacity-50 text-xs mr-2 font-mono">${new Date(log.time).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</span>
                        <span>${icon}${log.text}</span>
                    </div>
                `;
        });
      } else {
        timelineHtml = '<div class="text-center text-slate-500 italic">Không có dữ liệu lịch sử.</div>';
      }

      // Assemble
      content.innerHTML = `
            <div class="text-center mb-8 border-b border-white/10 pb-6">
                <div class="text-sm text-slate-400 uppercase tracking-widest mb-2">Báo cáo ván đấu</div>
                <h1 class="text-4xl font-black text-white mb-4 print:text-black">#${game.id.substring(0, 8)}</h1>
                <div class="inline-block px-6 py-3 rounded-2xl ${winnerColor} text-white font-bold text-xl shadow-lg print:border print:text-black print:bg-white">
                    ${winnerText}
                </div>
                <div class="mt-4 text-slate-400 text-sm">
                    Ngày: ${dateStr} • ${game.players.length} Người chơi
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 print:block">
                <div>
                    <h3 class="font-bold text-xl text-white mb-4 flex items-center gap-2 border-b border-white/10 pb-2 print:text-black">
                        <i data-lucide="users" class="text-indigo-400"></i> Danh sách người chơi
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs text-slate-500 uppercase border-b border-white/10">
                                    <th class="pb-2 pl-2">Tên</th>
                                    <th class="pb-2">Vai trò</th>
                                    <th class="pb-2">Trạng thái</th>
                                    <th class="pb-2">Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                ${playersHtml}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-xl text-white mb-4 flex items-center gap-2 border-b border-white/10 pb-2 print:text-black print:mt-8">
                        <i data-lucide="history" class="text-amber-400"></i> Diễn biến
                    </h3>
                    <div class="space-y-1">
                        ${timelineHtml}
                    </div>
                </div>
            </div>
            
            <div class="mt-12 text-center text-slate-600 text-xs border-t border-white/5 pt-4 print:mt-8">
                Quản Trò Ma Sói - Created by phamthanh99 (moevuive)
            </div>
        `;

      document.getElementById('report-modal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeReportModal() {
      document.getElementById('report-modal').classList.add('hidden');
    }

    function getFormattedTimestamp() {
      const now = new Date();
      const year = now.getFullYear();
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      return `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
    }

    function exportReportImage() {
      const element = document.getElementById('report-container');
      const btn = document.querySelector('button[onclick="exportReportImage()"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> <span class="hidden md:inline">Đang xuất...</span>';
      lucide.createIcons();

      // Tạm thời thay đổi style để xuất ảnh toàn màn hình
      const originalMaxWidth = element.style.maxWidth;
      element.style.width = '100%';
      element.style.maxWidth = 'none';
      // Tạm thời bỏ overflow để không bị scrollbar trong ảnh
      const playerListContainer = element.querySelector('.overflow-x-auto');
      if (playerListContainer) playerListContainer.classList.remove('overflow-x-auto');

      domtoimage.toSvg(element, {
        filter: (node) => !node.classList || !node.classList.contains('no-print'),
        width: element.scrollWidth,
        height: element.scrollHeight,
      })
        .then(function (dataUrl) {
          const link = document.createElement('a');
          link.download = `Werewolf_Report_${getFormattedTimestamp()}.svg`;
          link.href = dataUrl;
          link.click();
        })
        .catch(function (err) {
          console.error(err);
          alert("Lỗi khi xuất ảnh!");
        })
        .finally(function () {
          // Khôi phục lại style ban đầu
          element.style.maxWidth = originalMaxWidth;
          if (playerListContainer) playerListContainer.classList.add('overflow-x-auto');
          btn.innerHTML = originalText;
          lucide.createIcons();
        });
    }

    function deleteGame(e, id) { if (confirm('Xóa?')) { saveStoredGames(getStoredGames().filter(g => g.id !== id)); loadGamesList(); } }
    function finishGame() { updateGameData({ status: 'finished' }); navigateTo('home'); }
    function manualTogglePlayer(id) {
      const players = currentGameData.players.map(p => p.id === id ? { ...p, isAlive: !p.isAlive } : p);
      updateGameData({ players }); checkWinCondition(players);
    }
    function closeModal() { document.getElementById('action-modal').classList.add('hidden'); }
    function openModal(html) { document.getElementById('modal-content').innerHTML = html; document.getElementById('action-modal').classList.remove('hidden'); lucide.createIcons(); }
    function rerollRoles() { if (confirm('Đảo vai trò?')) executeReroll(); }
    function showNightOrder() {
      const orderDef = [
        { id: 'thief', name: 'Ăn Trộm', note: 'Đêm 1' },
        { id: 'cupid', name: 'Thần Tình Yêu', note: 'Đêm 1' },
        { id: 'two_sisters', name: 'Hai chị em', note: 'Đêm 1' },
        { id: 'three_brothers', name: 'Ba anh em', note: 'Đêm 1' },
        { id: 'hybrid_wolf', name: 'Sói Lai', note: 'Đêm 1' },
        { id: 'bodyguard', name: 'Bảo Vệ', note: '' },
        { id: 'fox', name: 'Cáo', note: '' },
        { id: 'seer', name: 'Tiên Tri', note: '' },
        { id: 'wolf_pack', name: 'Ma Sói (Cả đàn)', note: '' },
        { id: 'white_wolf', name: 'Sói Trắng (Riêng)', note: 'Đêm chẵn' },
        { id: 'witch', name: 'Phù Thủy', note: '' },
        { id: 'pied_piper', name: 'Thổi Sáo', note: '' },
        { id: 'hunter', name: 'Thợ Săn', note: '' }
      ];

      const presentIds = new Set(currentGameData.players.map(p => p.role.id));
      const hasWolf = currentGameData.players.some(p => ['werewolf', 'wolf_cub', 'white_wolf'].includes(p.role.id));

      let step = 1;
      const listHtml = orderDef.map(item => {
        let show = false;
        if (item.id === 'wolf_pack') show = hasWolf;
        else show = presentIds.has(item.id);

        if (!show) return '';

        let extraInfo = '';
        if (item.id === 'two_sisters') {
          const sisters = currentGameData.players.filter(p => p.role.id === 'two_sisters');
          if (sisters.length > 0) {
            extraInfo = `<div class="text-xs text-pink-300 mt-1 ml-9">(${sisters.map(p => p.name).join(', ')})</div>`;
          }
        }
        if (item.id === 'three_brothers') {
          const brothers = currentGameData.players.filter(p => p.role.id === 'three_brothers');
          if (brothers.length > 0) {
            extraInfo = `<div class="text-xs text-teal-300 mt-1 ml-9">(${brothers.map(p => p.name).join(', ')})</div>`;
          }
        }

        return `
            <div class="flex flex-col p-3 bg-slate-800/50 border border-slate-700 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center text-xs font-bold font-mono">${step++}</span>
                        <span class="font-medium text-slate-200">${item.name}</span>
                    </div>
                    <span class="text-xs text-slate-500">${item.note}</span>
                </div>
                ${extraInfo}
            </div>
        `;
      }).join('');

      openModal(`
        <div class="p-2">
            <h3 class="font-bold text-lg text-white mb-4 flex items-center gap-2">
                <i data-lucide="list-ordered" class="w-5 h-5 text-indigo-400"></i>
                Thứ tự hành động Đêm
            </h3>
            <div class="space-y-2 max-h-[60vh] overflow-y-auto custom-scrollbar">
                ${listHtml || '<p class="text-slate-500 text-center">Không có vai trò đặc biệt nào.</p>'}
            </div>
        </div>
      `);
    }
    function executeReroll() {
      if (!currentGameData) return;

      // Collect all roles (players + leftovers)
      let allRoles = currentGameData.players.map(p => ({ id: p.role.id, name: p.role.name, team: p.role.team }));
      if (currentGameData.leftoverRoles && currentGameData.leftoverRoles.length > 0) {
        const leftovers = currentGameData.leftoverRoles.map(r => ({ id: r.id, name: r.name, team: r.team }));
        allRoles = allRoles.concat(leftovers);
      }

      // Shuffle
      allRoles = shuffleArray(allRoles);

      // Re-assign
      const newPlayers = currentGameData.players.map((p, idx) => {
        const newRole = allRoles[idx];
        return {
          ...p,
          role: newRole,
          elderLives: newRole.id === 'elder' ? 2 : 1,
          isAlive: true,
          isCharmed: false,
          isLover: false,
          loverId: null,
          revealed: false,
          isFoxPowerLost: false, // Reset Fox Power
          deathPhase: null,
          usedAbilities: [],
          originalRole: null
        };
      });

      const newLeftovers = allRoles.slice(newPlayers.length);
      updateGameData({ players: newPlayers, leftoverRoles: newLeftovers });
      pushLogInternal("🔄 Quản trò đã đảo lại vai trò.");
    }
    function addLogFromInput() {
      const v = document.getElementById('log-input').value;
      if (v) { pushLogInternal(v); document.getElementById('log-input').value = ''; }
    }

    function toggleMobileLogs() {
      const container = document.getElementById('logs-container');
      const inputArea = document.getElementById('log-input-area');
      const preview = document.getElementById('mobile-latest-log');
      const icon = document.getElementById('log-toggle-icon');

      const isCollapsed = container.classList.contains('mobile-hidden');

      if (isCollapsed) {
        container.classList.remove('mobile-hidden');
        inputArea.classList.remove('mobile-hidden');
        preview.classList.add('hidden');
        icon.style.transform = 'rotate(180deg)';
      } else {
        container.classList.add('mobile-hidden');
        inputArea.classList.add('mobile-hidden');
        preview.classList.remove('hidden');
        icon.style.transform = 'rotate(0deg)';
      }
    }

  </script>
</body>

</html>